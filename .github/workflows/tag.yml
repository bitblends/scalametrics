name: Tag

# Trigger only on pushes to the "main" branch, ignoring changes in "gh-pages/"
on:
  push:
    branches: [main]
    paths-ignore:
      - 'gh-pages/**'

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:

  ##############
  # Job Status #
  ##############
  enforce-all-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      checks: read
    steps:
      - name: GitHub Checks
        uses: poseidon/wait-for-status-checks@v0.6.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  ###########################
  # Detect gh-pages/ Change #
  ###########################
  gh-pages-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check for exclusive gh-pages changes
        id: check
        run: |
          set -Eeuo pipefail
          BEFORE='${{ github.event.before }}'
          AFTER='${{ github.sha }}'

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || ! git cat-file -e "${BEFORE}^{commit}" 2>/dev/null; then
            CHANGED="$(git diff-tree --no-commit-id --name-only -r "$AFTER")"
          else
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER")"
          fi

          echo "Changed files:"
          echo "$CHANGED"

          if [ -z "$CHANGED" ]; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If any file is outside gh-pages/, do not skip
          if echo "$CHANGED" | grep -v '^gh-pages/' >/dev/null; then
            echo "skip=false" >> "$GITHUB_OUTPUT"
          else
            # All files are inside gh-pages/
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

  ############
  # Tag Bump #
  ############
  tag:
    name: Create a Tag
    needs: gh-pages-changes
    if: needs.gh-pages-changes.outputs.skip != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      new-tag: ${{ steps.tag_bump.outputs.new_tag }}
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v5
        id: checkout
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha || github.sha }}
          fetch-depth: '0'
          fetch-tags: true
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: temurin
          cache: sbt
      - name: Setup SBT
        uses: sbt/setup-sbt@v1
      - name: Build
        run: sbt -v +compile
      - name: Tag the branch with the latest version
        uses: anothrNick/github-tag-action@v1
        id: tag_bump
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
          TAG_PREFIX: v
          DEFAULT_BUMP: patch
          INITIAL_VERSION: 0.1.0